apiVersion: batch/v1
kind: Job
metadata:
   name: s3-config-job
   namespace: storage
   annotations:
      argocd.argoproj.io/hook: PostSync
      # argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
   template:
      spec:
         containers:
            - name: create-buckets
              image: seaweedfs-placeholder
              command: ["/bin/sh", "-c"]
              args:
                 - |
                    echo "Waiting for SeaweedFS Master..."
                    # Use specific pod DNS for stability
                    MASTER="seaweedfs-master-0.seaweedfs-master.storage:9333"
                    FILER="seaweedfs-filer-0.seaweedfs-filer.storage:8888"

                    until echo "s3.bucket.list" | weed shell -master=$MASTER; do
                      echo "Waiting for master at $MASTER..."
                      sleep 2
                    done

                    echo "Creating Users and Buckets..."

                    # 1. Define Users first (Idempotent: updates if exists)
                    echo "Initializing Users..."
                    weed shell -master=$MASTER <<EOF
                    s3.configure -user=mimir -access_key=mimir -secret_key=mimir -actions=Read,Write,List,Tagging,Admin -apply
                    s3.configure -user=loki -access_key=loki -secret_key=loki -actions=Read,Write,List,Tagging,Admin -apply
                    s3.configure -user=alertmanager -access_key=alertmanager -secret_key=alertmanager -actions=Read,Write,List,Tagging,Admin -apply
                    s3.configure -user=admin -access_key=admin -secret_key=admin -actions=Read,Write,List,Tagging,Admin -apply
                    EOF

                    # 2. Create Buckets with Strict Ownership
                    # Now that users exist, we create buckets assigning them as owners.

                    # Mimir Buckets
                    for BUCKET in mimir-tsdb mimir-ruler mimir-alertmanager; do
                       echo "Checking bucket $BUCKET..."
                       if ! echo "s3.bucket.list" | weed shell -master=$MASTER | grep -q "$BUCKET"; then
                          echo "Creating bucket $BUCKET for user mimir..."
                          echo "s3.bucket.create -name=$BUCKET -owner=mimir" | weed shell -master=$MASTER
                       else
                          echo "Bucket $BUCKET already exists."
                       fi
                    done

                    # Loki Buckets
                    for BUCKET in loki-chunks loki-ruler loki-admin; do
                       echo "Checking bucket $BUCKET..."
                       if ! echo "s3.bucket.list" | weed shell -master=$MASTER | grep -q "$BUCKET"; then
                          echo "Creating bucket $BUCKET for user loki..."
                          echo "s3.bucket.create -name=$BUCKET -owner=loki" | weed shell -master=$MASTER
                       else
                          echo "Bucket $BUCKET already exists."
                       fi
                    done

                    # Alertmanager Buckets
                    for BUCKET in alertmanager; do
                       echo "Checking bucket $BUCKET..."
                       if ! echo "s3.bucket.list" | weed shell -master=$MASTER | grep -q "$BUCKET"; then
                          echo "Creating bucket $BUCKET for user alertmanager..."
                          echo "s3.bucket.create -name=$BUCKET -owner=alertmanager" | weed shell -master=$MASTER
                       else
                          echo "Bucket $BUCKET already exists."
                       fi
                    done

                    # 3. Assign Buckets to Users (Strict Ownership)
                    echo "Assigning Buckets to Users..."
                    weed shell -master=$MASTER <<EOF
                    s3.configure -user=mimir -buckets=mimir-tsdb,mimir-ruler,mimir-alertmanager -apply
                    s3.configure -user=loki -buckets=loki-chunks,loki-ruler,loki-admin -apply
                    s3.configure -user=alertmanager -buckets=alertmanager -apply
                    EOF
         restartPolicy: OnFailure
