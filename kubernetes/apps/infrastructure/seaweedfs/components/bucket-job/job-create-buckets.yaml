apiVersion: batch/v1
kind: Job
metadata:
  name: create-system-buckets
  namespace: storage
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
        - name: create-buckets
          image: chrislusf/seaweedfs:4.07
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Waiting for SeaweedFS Master..."
              # Use specific pod DNS for stability
              MASTER="seaweedfs-master-0.seaweedfs-master.storage:9333"
              FILER="seaweedfs-filer-0.seaweedfs-filer.storage:8888"

              until echo "s3.bucket.list" | weed shell -master=$MASTER; do
                echo "Waiting for master at $MASTER..."
                sleep 2
              done

              echo "Creating Buckets and Users..."
              weed shell -master=$MASTER <<EOF
              s3.bucket.create -name=mimir-tsdb
              s3.bucket.create -name=mimir-ruler
              s3.bucket.create -name=mimir-alertmanager
              s3.bucket.create -name=loki-chunks
              s3.bucket.create -name=loki-ruler
              s3.bucket.create -name=loki-admin

              # Configure Mimir User (Owner of Mimir buckets)
              s3.configure -user=mimir -access_key=mimir -secret_key=mimir -actions=Read,Write,List,Tagging,Admin -buckets=mimir-tsdb,mimir-ruler,mimir-alertmanager

              # Configure Loki User (Owner of Loki buckets)
              s3.configure -user=loki -access_key=loki -secret_key=loki -actions=Read,Write,List,Tagging,Admin -buckets=loki-chunks,loki-ruler,loki-admin

              # Configure Admin User (Access to all)
              s3.configure -user=admin -access_key=admin -secret_key=admin -actions=Read,Write,List,Tagging,Admin
              EOF
      restartPolicy: OnFailure
