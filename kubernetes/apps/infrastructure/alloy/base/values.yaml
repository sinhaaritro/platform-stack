alloy:
  configMap:
    create: true
    content: |
      // Logging: Discovery
      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pod_logs" {
        targets = discovery.kubernetes.pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          action = "keep"
          regex = ".*"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label = "container"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label = "node"
        }
      }

      // Logging: Source
      loki.source.kubernetes "pod_logs" {
        targets    = discovery.relabel.pod_logs.output
        forward_to = [loki.write.default.receiver]
      }

      // Logging: Write
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.logging.svc.cluster.local:80/loki/api/v1/push"
          tenant_id = "1"
        }
      }

      // Metrics: Discovery (Node Exporter)
      discovery.kubernetes "nodes" {
        role = "service"
      }

      discovery.relabel "node_exporter" {
        targets = discovery.kubernetes.nodes.targets
        rule {
          source_labels = ["__meta_kubernetes_service_name"]
          regex = ".*node-exporter.*"
          action = "keep"
        }
      }

      // Metrics: Discovery (SeaweedFS)
      discovery.relabel "seaweedfs" {
        targets = discovery.kubernetes.nodes.targets
        rule {
          source_labels = ["__meta_kubernetes_service_name"]
          regex = "seaweedfs-(master|volume|filer|s3)"
          action = "keep"
        }
        rule {
          target_label = "__address__"
          replacement  = "${1}:9327"
          source_labels = ["__address__"]
          regex = "([^:]+)(?::\\d+)?"
        }
      }

      // Metrics: Scrape
      prometheus.scrape "node_exporter" {
        job_name   = "node-exporter"
        targets    = discovery.relabel.node_exporter.output
        forward_to = [prometheus.remote_write.mimir.receiver]
        scrape_interval = "15s"
      }

      prometheus.scrape "seaweedfs" {
        job_name   = "seaweedfs"
        targets    = discovery.relabel.seaweedfs.output
        forward_to = [prometheus.remote_write.mimir.receiver]
        scrape_interval = "15s"
      }

      // Metrics: Write
      prometheus.remote_write "mimir" {
        endpoint {
          url = "http://mimir-nginx.monitoring.svc.cluster.local:80/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "anonymous",
          }
        }
      }

  clustering:
    enabled: true
    portName: http

  stabilityLevel: "generally-available"
  storagePath: /var/lib/alloy/data

  enableHttpServerPort: true
  listenAddr: 0.0.0.0
  listenPort: 12345
  listenScheme: HTTP

  uiPathPrefix: /
  enableReporting: true

  securityContext:
    privileged: true

  resources:
    limits:
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  mounts:
    varlog: true
    dockercontainers: true

controller:
  type: "daemonset"
  replicas: 1
  enableStatefulSetAutoDeletePVC: false

service:
  enabled: true
  type: ClusterIP
  internalTrafficPolicy: Cluster

serviceMonitor:
  enabled: false

ingress:
  enabled: true
  ingressClassName: traefik
  hosts:
    - alloy.local

rbac:
  create: true

serviceAccount:
  create: true
  automountServiceAccountToken: true

configReloader:
  enabled: true
