apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: core-infrastructure
  namespace: argocd
spec:
  goTemplate: true
  generators:
    - matrix:
        generators:
          - clusters: {}
          - git:
              repoURL: https://github.com/sinhaaritro/platform-stack.git
              revision: HEAD
              files:
                - path: 'kubernetes/clusters/{{if eq .name "in-cluster"}}ruth{{else}}{{.name}}{{end}}/**/app.yaml'
  template:
    metadata:
      name: '{{if eq .name "in-cluster"}}ruth{{else}}{{.name}}{{end}}-{{appName}}'
      labels:
        tier: "{{tier}}"
    spec:
      ignoreDifferences:
        - group: ""
          kind: Secret
          name: "sealed-secrets-key*"
          jsonPointers:
            - /data
        - group: apps
          kind: StatefulSet
          jsonPointers:
            - /spec/volumeClaimTemplates/0/status
            - /spec/volumeClaimTemplates/0/spec/volumeMode
            - /spec/volumeClaimTemplates/1/status
            - /spec/volumeClaimTemplates/1/spec/volumeMode
            - /spec/volumeClaimTemplates/2/status
            - /spec/volumeClaimTemplates/2/spec/volumeMode
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: bgpadvertisements.metallb.io
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: bgppeers.metallb.io
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: bfdprofiles.metallb.io
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: communities.metallb.io
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: ipaddresspools.metallb.io
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
        - group: apiextensions.k8s.io
          kind: CustomResourceDefinition
          name: l2advertisements.metallb.io
          jsonPointers:
            - /spec/conversion/webhook/clientConfig/caBundle
      project: default
      source:
        repoURL: https://github.com/sinhaaritro/platform-stack.git
        targetRevision: HEAD
        path: "{{path.directory}}"
      destination:
        server: "{{.server}}"
        namespace: "{{namespace}}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - Replace=false
        retry:
          limit: 10
          backoff:
            duration: "5s"
            factor: 2
            maxDuration: "3m"

  # Only include apps marked as 'core'
  selector:
    matchExpressions:
      - key: tier
        operator: In
        values:
          - core
