apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: logging

resources:
  - ../../../apps/infrastructure/promtail

patches:
  - target:
      kind: Secret
      name: promtail
    patch: |-
      - op: replace
        path: /stringData/promtail.yaml
        value: |
          server:
            log_level: debug
            http_listen_port: 3101
            enable_runtime_reload: true
          
          clients:
            - url: http://loki.ruth.example.com/loki/api/v1/push
          
          positions:
            filename: /run/promtail/positions.yaml
          
          scrape_configs:
            - job_name: kubernetes-pods
              pipeline_stages:
                - cri: {}
              kubernetes_sd_configs:
                - role: pod
              relabel_configs:
                - source_labels: [__meta_kubernetes_pod_controller_name]
                  target_label: __service__
                - source_labels: [__meta_kubernetes_pod_node_name]
                  target_label: __host__
                - action: labelmap
                  regex: __meta_kubernetes_pod_label_(.+)
                - action: replace
                  replacement: $1
                  separator: /
                  source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_name]
                  target_label: job
                - action: replace
                  source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                - action: replace
                  source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                - action: replace
                  source_labels: [__meta_kubernetes_pod_container_name]
                  target_label: container
                - replacement: /var/log/pods/*$1/*.log
                  separator: /
                  source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
                  target_label: __path__

  - target:
      kind: DaemonSet
      name: promtail
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext/runAsUser
        value: 0
      - op: add
        path: /spec/template/spec/securityContext/runAsGroup
        value: 0
