apiVersion: v1
automountServiceAccountToken: true
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs
  namespace: storage
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-rw-cr
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-rw-crb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: seaweedfs-rw-cr
subjects:
- kind: ServiceAccount
  name: seaweedfs
  namespace: storage
---
apiVersion: v1
data:
  master.toml: |2-

    # Enter any extra configuration for master.toml here.
    # It may be a multi-line string.
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-master-config
  namespace: storage
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: keep
  labels:
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-db-secret
  namespace: storage
stringData:
  password: MDVkZDJjODRlZTNjZjU1M2MzYzVlNzUx
  user: YourSWUser
type: Opaque
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/resource-policy: keep
  labels:
    app.kubernetes.io/component: s3
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-s3-secret
  namespace: storage
stringData:
  admin_access_key_id: L4R7lKHvXeBXhB2PxcBu
  admin_secret_access_key: jVGkOhwV5QNcSmxDLb7VErbvtRlXKKlqq3VdYeJ9
  read_access_key_id: dk0W0W1qwQVoTfldy1EW
  read_secret_access_key: pNY3imwsDHk01leOdaoXVuIWUYcfPFXEpecrUvTm
  seaweedfs_s3_config: '{"identities":[{"name":"anvAdmin","credentials":[{"accessKey":"L4R7lKHvXeBXhB2PxcBu","secretKey":"jVGkOhwV5QNcSmxDLb7VErbvtRlXKKlqq3VdYeJ9"}],"actions":["Admin","Read","Write"]},{"name":"anvReadOnly","credentials":[{"accessKey":"dk0W0W1qwQVoTfldy1EW","secretKey":"pNY3imwsDHk01leOdaoXVuIWUYcfPFXEpecrUvTm"}],"actions":["Read"]}]}'
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: admin
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-admin
  namespace: storage
spec:
  ports:
  - name: http
    port: 23646
    protocol: TCP
    targetPort: 23646
  - name: grpc
    port: 33646
    protocol: TCP
    targetPort: 33646
  selector:
    app.kubernetes.io/component: admin
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
  labels:
    app.kubernetes.io/component: filer
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-filer
  namespace: storage
spec:
  clusterIP: None
  ports:
  - name: swfs-filer
    port: 8888
    protocol: TCP
    targetPort: 8888
  - name: swfs-filer-grpc
    port: 18888
    protocol: TCP
    targetPort: 18888
  - name: metrics
    port: 9327
    protocol: TCP
    targetPort: 9327
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/component: filer
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: filer
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
    monitoring: "true"
  name: seaweedfs-filer-client
  namespace: storage
spec:
  clusterIP: None
  ports:
  - name: swfs-filer
    port: 8888
    protocol: TCP
    targetPort: 8888
  - name: swfs-filer-grpc
    port: 18888
    protocol: TCP
    targetPort: 18888
  - name: metrics
    port: 9327
    protocol: TCP
    targetPort: 9327
  selector:
    app.kubernetes.io/component: filer
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
  labels:
    app.kubernetes.io/component: master
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-master
  namespace: storage
spec:
  clusterIP: None
  ports:
  - name: swfs-master
    port: 9333
    protocol: TCP
    targetPort: 9333
  - name: swfs-master-grpc
    port: 19333
    protocol: TCP
    targetPort: 19333
  - name: metrics
    port: 9327
    protocol: TCP
    targetPort: 9327
  publishNotReadyAddresses: true
  selector:
    app.kubernetes.io/component: master
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: s3
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-s3
  namespace: storage
spec:
  internalTrafficPolicy: Cluster
  ports:
  - name: swfs-s3
    port: 8333
    protocol: TCP
    targetPort: 8333
  - name: metrics
    port: 9327
    protocol: TCP
    targetPort: 9327
  selector:
    app.kubernetes.io/component: s3
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: volume
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-volume
  namespace: storage
spec:
  clusterIP: None
  internalTrafficPolicy: Cluster
  ports:
  - name: swfs-volume
    port: 8080
    protocol: TCP
    targetPort: 8080
  - name: swfs-volume-18080
    port: 18080
    protocol: TCP
    targetPort: 18080
  - name: metrics
    port: 9327
    protocol: TCP
    targetPort: 9327
  selector:
    app.kubernetes.io/component: volume
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: worker
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-worker
  namespace: storage
spec:
  clusterIP: None
  ports:
  - name: metrics
    port: 9327
    protocol: TCP
    targetPort: 9327
  selector:
    app.kubernetes.io/component: worker
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/name: seaweedfs
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: s3
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-s3
  namespace: storage
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: s3
      app.kubernetes.io/instance: seaweedfs
      app.kubernetes.io/name: seaweedfs
  template:
    metadata:
      labels:
        app.kubernetes.io/component: s3
        app.kubernetes.io/instance: seaweedfs
        app.kubernetes.io/name: seaweedfs
        helm.sh/chart: seaweedfs-4.0.409
    spec:
      containers:
      - command:
        - /bin/sh
        - -ec
        - |
          exec /usr/bin/weed \
          -logdir=/logs \
          -v=1 \
          s3 \
          -ip.bind=0.0.0.0 \
          -port=8333 \
          -metricsPort 9327 \
          -config=/etc/sw/seaweedfs_s3_config \
          -filer=seaweedfs-filer-client.storage:8888 \
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SEAWEEDFS_FULLNAME
          value: seaweedfs
        - name: WEED_CLUSTER_DEFAULT
          value: sw
        - name: WEED_CLUSTER_SW_FILER
          value: seaweedfs-filer-client.storage:8888
        - name: WEED_CLUSTER_SW_MASTER
          value: seaweedfs-master.storage:9333
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 20
          httpGet:
            path: /status
            port: 8333
            scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 60
          successThreshold: 1
          timeoutSeconds: 10
        name: seaweedfs
        ports:
        - containerPort: 8333
          name: swfs-s3
        - containerPort: 9327
          name: metrics
        readinessProbe:
          failureThreshold: 100
          httpGet:
            path: /status
            port: 8333
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 15
          successThreshold: 1
          timeoutSeconds: 10
        volumeMounts:
        - mountPath: /logs/
          name: logs
        - mountPath: /etc/sw
          name: config-users
          readOnly: true
      enableServiceLinks: false
      restartPolicy: Always
      terminationGracePeriodSeconds: 10
      volumes:
      - name: config-users
        secret:
          defaultMode: 420
          secretName: seaweedfs-s3-secret
      - hostPath:
          path: /storage/logs/seaweedfs/s3
          type: DirectoryOrCreate
        name: logs
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: worker
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-worker
  namespace: storage
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: worker
      app.kubernetes.io/instance: seaweedfs
      app.kubernetes.io/name: seaweedfs
  template:
    metadata:
      annotations: null
      labels:
        app.kubernetes.io/component: worker
        app.kubernetes.io/instance: seaweedfs
        app.kubernetes.io/name: seaweedfs
        helm.sh/chart: seaweedfs-4.0.409
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: worker
                  app.kubernetes.io/instance: seaweedfs
                  app.kubernetes.io/name: seaweedfs
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /bin/sh
        - -ec
        - |
          exec /usr/bin/weed \
          -logdir=/logs \
          -v=1 \
          worker \
          -admin=seaweedfs-admin.storage:23646.33646 \
          -capabilities=vacuum,balance,erasure_coding \
          -maxConcurrent=3 \
          -workingDir=/tmp/seaweedfs-worker \
          -metricsPort=9327
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SEAWEEDFS_FULLNAME
          value: seaweedfs
        - name: WEED_CLUSTER_DEFAULT
          value: sw
        - name: WEED_CLUSTER_SW_FILER
          value: seaweedfs-filer-client.storage:8888
        - name: WEED_CLUSTER_SW_MASTER
          value: seaweedfs-master.storage:9333
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: metrics
          initialDelaySeconds: 30
          periodSeconds: 60
          successThreshold: 1
          timeoutSeconds: 10
        name: seaweedfs
        ports:
        - containerPort: 9327
          name: metrics
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /ready
            port: metrics
          initialDelaySeconds: 20
          periodSeconds: 15
          successThreshold: 1
          timeoutSeconds: 10
        resources:
          limits:
            cpu: "2"
            memory: 2Gi
          requests:
            cpu: 500m
            memory: 512Mi
        volumeMounts:
        - mountPath: /tmp/seaweedfs-worker
          name: worker-data
        - mountPath: /logs
          name: worker-logs
      enableServiceLinks: false
      restartPolicy: Always
      terminationGracePeriodSeconds: 60
      volumes:
      - emptyDir: {}
        name: worker-data
      - emptyDir: {}
        name: worker-logs
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/component: admin
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-admin
  namespace: storage
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: admin
      app.kubernetes.io/instance: seaweedfs
      app.kubernetes.io/name: seaweedfs
  serviceName: seaweedfs-admin
  template:
    metadata:
      annotations: null
      labels:
        app.kubernetes.io/component: admin
        app.kubernetes.io/instance: seaweedfs
        app.kubernetes.io/name: seaweedfs
        helm.sh/chart: seaweedfs-4.0.409
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: admin
                  app.kubernetes.io/instance: seaweedfs
                  app.kubernetes.io/name: seaweedfs
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /bin/sh
        - -ec
        - |
          exec /usr/bin/weed \
          -logdir=/logs \
          -v=1 \
          admin \
          -port=23646 \
          -port.grpc=33646 \
          -dataDir=/data \
          -masters=${SEAWEEDFS_FULLNAME}-master-0.${SEAWEEDFS_FULLNAME}-master.storage:9333
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SEAWEEDFS_FULLNAME
          value: seaweedfs
        - name: WEED_CLUSTER_DEFAULT
          value: sw
        - name: WEED_CLUSTER_SW_FILER
          value: seaweedfs-filer-client.storage:8888
        - name: WEED_CLUSTER_SW_MASTER
          value: seaweedfs-master.storage:9333
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: http
            scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 60
          successThreshold: 1
          timeoutSeconds: 10
        name: seaweedfs
        ports:
        - containerPort: 23646
          name: http
        - containerPort: 33646
          name: grpc
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: http
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 15
          successThreshold: 1
          timeoutSeconds: 10
        volumeMounts:
        - mountPath: /data
          name: admin-data
        - mountPath: /logs
          name: admin-logs
      enableServiceLinks: false
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      volumes: null
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: admin-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      storageClassName: longhorn
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: admin-logs
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      storageClassName: longhorn0rep
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/component: filer
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-filer
  namespace: storage
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: filer
      app.kubernetes.io/instance: seaweedfs
      app.kubernetes.io/name: seaweedfs
  serviceName: seaweedfs-filer
  template:
    metadata:
      annotations:
        checksum/s3config: 7108f96dcacfe1dacd0de7753c39259af64a33ccea81b763c866129c6d6e4653
      labels:
        app.kubernetes.io/component: filer
        app.kubernetes.io/instance: seaweedfs
        app.kubernetes.io/name: seaweedfs
        helm.sh/chart: seaweedfs-4.0.409
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: filer
                  app.kubernetes.io/instance: seaweedfs
                  app.kubernetes.io/name: seaweedfs
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /bin/sh
        - -ec
        - |
          exec /usr/bin/weed \
          -logdir=/logs \
          -v=1 \
          filer \
          -port=8888 \
          -metricsPort=9327 \
          -dirListLimit=100000 \
          -defaultReplicaPlacement=000 \
          -ip=${POD_IP} \
          -ip.bind=0.0.0.0 \
          -master=seaweedfs-master-0.seaweedfs-master.storage:9333 \
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: WEED_MYSQL_USERNAME
          valueFrom:
            secretKeyRef:
              key: user
              name: seaweedfs-db-secret
              optional: true
        - name: WEED_MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: seaweedfs-db-secret
              optional: true
        - name: SEAWEEDFS_FULLNAME
          value: seaweedfs
        - name: WEED_FILER_BUCKETS_FOLDER
          value: /buckets
        - name: WEED_FILER_OPTIONS_RECURSIVE_DELETE
          value: "false"
        - name: WEED_LEVELDB2_ENABLED
          value: "true"
        - name: WEED_MYSQL_CONNECTION_MAX_IDLE
          value: "5"
        - name: WEED_MYSQL_CONNECTION_MAX_LIFETIME_SECONDS
          value: "600"
        - name: WEED_MYSQL_CONNECTION_MAX_OPEN
          value: "75"
        - name: WEED_MYSQL_DATABASE
          value: sw_database
        - name: WEED_MYSQL_ENABLED
          value: "false"
        - name: WEED_MYSQL_HOSTNAME
          value: mysql-db-host
        - name: WEED_MYSQL_INTERPOLATEPARAMS
          value: "true"
        - name: WEED_MYSQL_PORT
          value: "3306"
        - name: WEED_CLUSTER_DEFAULT
          value: sw
        - name: WEED_CLUSTER_SW_FILER
          value: seaweedfs-filer-client.storage:8888
        - name: WEED_CLUSTER_SW_MASTER
          value: seaweedfs-master.storage:9333
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /
            port: 8888
            scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 10
        name: seaweedfs
        ports:
        - containerPort: 8888
          name: swfs-filer
        - containerPort: 9327
          name: metrics
        - containerPort: 18888
        readinessProbe:
          failureThreshold: 100
          httpGet:
            path: /
            port: 8888
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 15
          successThreshold: 1
          timeoutSeconds: 10
        volumeMounts:
        - mountPath: /logs/
          name: seaweedfs-filer-log-volume
        - mountPath: /data
          name: data-filer
      enableServiceLinks: false
      restartPolicy: Always
      serviceAccountName: seaweedfs
      terminationGracePeriodSeconds: 60
      volumes:
      - configMap:
          name: seaweedfs-db-init-config
        name: db-schema-config-volume
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data-filer
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      storageClassName: longhorn
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: seaweedfs-filer-log-volume
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: longhorn0rep
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/component: master
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-master
  namespace: storage
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: master
      app.kubernetes.io/instance: seaweedfs
      app.kubernetes.io/name: seaweedfs
  serviceName: seaweedfs-master
  template:
    metadata:
      labels:
        app.kubernetes.io/component: master
        app.kubernetes.io/instance: seaweedfs
        app.kubernetes.io/name: seaweedfs
        helm.sh/chart: seaweedfs-4.0.409
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: master
                  app.kubernetes.io/instance: seaweedfs
                  app.kubernetes.io/name: seaweedfs
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /bin/sh
        - -ec
        - |
          exec /usr/bin/weed \
          -logdir=/logs \
          -v=1 \
          master \
          -port=9333 \
          -mdir=/data \
          -ip.bind=0.0.0.0 \
          -defaultReplication=000 \
          -metricsPort=9327 \
          -volumeSizeLimitMB=2000 \
          -electionTimeout=10s \
          -heartbeatInterval=300ms \
          -ip=${POD_NAME}.seaweedfs-master.storage \
          -peers=seaweedfs-master-0.seaweedfs-master.storage:9333 \
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SEAWEEDFS_FULLNAME
          value: seaweedfs
        - name: WEED_MASTER_VOLUME_GROWTH_COPY_1
          value: "7"
        - name: WEED_MASTER_VOLUME_GROWTH_COPY_2
          value: "6"
        - name: WEED_MASTER_VOLUME_GROWTH_COPY_3
          value: "3"
        - name: WEED_MASTER_VOLUME_GROWTH_COPY_OTHER
          value: "1"
        - name: WEED_CLUSTER_DEFAULT
          value: sw
        - name: WEED_CLUSTER_SW_FILER
          value: seaweedfs-filer-client.storage:8888
        - name: WEED_CLUSTER_SW_MASTER
          value: seaweedfs-master.storage:9333
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 4
          httpGet:
            path: /cluster/status
            port: 9333
            scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 10
        name: seaweedfs
        ports:
        - containerPort: 9333
          name: swfs-master
        - containerPort: 19333
        readinessProbe:
          failureThreshold: 100
          httpGet:
            path: /cluster/status
            port: 9333
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 45
          successThreshold: 2
          timeoutSeconds: 10
        resources:
          requests: {}
        volumeMounts:
        - mountPath: /data
          name: data-storage
        - mountPath: /logs/
          name: seaweedfs-master-log-volume
        - mountPath: /etc/seaweedfs/master.toml
          name: master-config
          readOnly: true
          subPath: master.toml
      enableServiceLinks: false
      restartPolicy: Always
      serviceAccountName: seaweedfs
      terminationGracePeriodSeconds: 60
      volumes:
      - configMap:
          name: seaweedfs-master-config
        name: master-config
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data-storage
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: longhorn
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: seaweedfs-master-log-volume
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: longhorn0rep
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/component: volume
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: seaweedfs-volume
  namespace: storage
spec:
  podManagementPolicy: Parallel
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: volume
      app.kubernetes.io/instance: seaweedfs
      app.kubernetes.io/name: seaweedfs
  serviceName: seaweedfs-volume
  template:
    metadata:
      labels:
        app.kubernetes.io/component: volume
        app.kubernetes.io/instance: seaweedfs
        app.kubernetes.io/name: seaweedfs
        helm.sh/chart: seaweedfs-4.0.409
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: volume
                  app.kubernetes.io/instance: seaweedfs
                  app.kubernetes.io/name: seaweedfs
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - command:
        - /bin/sh
        - -ec
        - |
          exec /usr/bin/weed \
            -logdir=/logs \
            -v=1 \
            volume \
            -port=8080 \
            -metricsPort=9327 \
            -dir /data \
            -dir.idx=/idx \
            -max 7 \
            -ip.bind=0.0.0.0 \
            -readMode=proxy \
            -minFreeSpacePercent=1 \
            -ip=${POD_NAME}.seaweedfs-volume.storage \
            -compactionMBps=50 \
            -master=seaweedfs-master-0.seaweedfs-master.storage:9333 \
            -publicUrl=${POD_NAME}.${SEAWEEDFS_FULLNAME}-volume.seaweedfs.ruth.example.com:80 \
            -max=15 \
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: SEAWEEDFS_FULLNAME
          value: seaweedfs
        - name: WEED_CLUSTER_DEFAULT
          value: sw
        - name: WEED_CLUSTER_SW_FILER
          value: seaweedfs-filer-client.storage:8888
        - name: WEED_CLUSTER_SW_MASTER
          value: seaweedfs-master.storage:9333
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 4
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 20
          periodSeconds: 90
          successThreshold: 1
          timeoutSeconds: 30
        name: seaweedfs
        ports:
        - containerPort: 8080
          name: swfs-vol
        - containerPort: 9327
          name: metrics
        - containerPort: 18080
          name: swfs-vol-grpc
        readinessProbe:
          failureThreshold: 100
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 15
          periodSeconds: 15
          successThreshold: 1
          timeoutSeconds: 30
        volumeMounts:
        - mountPath: /data/
          name: data
        - mountPath: /logs/
          name: logs
        - mountPath: /idx/
          name: idx
      enableServiceLinks: false
      initContainers:
      - args:
        - 'if ls /data/*.idx  >/dev/null 2>&1; then mv /data/*.idx /idx/ ; fi; '
        command:
        - /bin/sh
        - -c
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        name: seaweedfs-vol-move-idx
        volumeMounts:
        - mountPath: /idx
          name: idx
        - mountPath: /data
          name: data
      - args:
        - 'weed fix /data; if ls /data/*.idx  >/dev/null 2>&1; then mv /data/*.idx
          /idx/ ; fi; '
        command:
        - /bin/sh
        - -c
        image: chrislusf/seaweedfs:4.09
        imagePullPolicy: IfNotPresent
        name: seaweedfs-vol-fix-idx
        volumeMounts:
        - mountPath: /idx
          name: idx
        - mountPath: /data
          name: data
      restartPolicy: Always
      serviceAccountName: seaweedfs
      terminationGracePeriodSeconds: 150
  volumeClaimTemplates:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 20Gi
      storageClassName: longhorn0rep
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: idx
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: longhorn0rep
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: logs
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
      storageClassName: longhorn0rep
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/hook: PostSync
  name: s3-config-job
  namespace: storage
spec:
  template:
    spec:
      containers:
      - args:
        - |
          echo "Waiting for SeaweedFS Master..."
          # Use specific pod DNS for stability
          MASTER="seaweedfs-master-0.seaweedfs-master.storage:9333"
          FILER="seaweedfs-filer-0.seaweedfs-filer.storage:8888"

          until echo "s3.bucket.list" | weed shell -master=$MASTER; do
            echo "Waiting for master at $MASTER..."
            sleep 2
          done

          echo "Creating Users and Buckets..."

          # 1. Define Users first (Idempotent: updates if exists)
          echo "Initializing Users..."
          weed shell -master=$MASTER <<EOF
          s3.configure -user=mimir -access_key=mimir -secret_key=mimir -actions=Read,Write,List,Tagging,Admin -apply
          s3.configure -user=loki -access_key=loki -secret_key=loki -actions=Read,Write,List,Tagging,Admin -apply
          s3.configure -user=alertmanager -access_key=alertmanager -secret_key=alertmanager -actions=Read,Write,List,Tagging,Admin -apply
          s3.configure -user=admin -access_key=admin -secret_key=admin -actions=Read,Write,List,Tagging,Admin -apply
          EOF

          # 2. Create Buckets with Strict Ownership
          # Now that users exist, we create buckets assigning them as owners.

          # Mimir Buckets
          for BUCKET in mimir-tsdb mimir-ruler mimir-alertmanager; do
             echo "Checking bucket $BUCKET..."
             if ! echo "s3.bucket.list" | weed shell -master=$MASTER | grep -q "$BUCKET"; then
                echo "Creating bucket $BUCKET for user mimir..."
                echo "s3.bucket.create -name=$BUCKET -owner=mimir" | weed shell -master=$MASTER
             else
                echo "Bucket $BUCKET already exists."
             fi
          done

          # Loki Buckets
          for BUCKET in loki-chunks loki-ruler loki-admin; do
             echo "Checking bucket $BUCKET..."
             if ! echo "s3.bucket.list" | weed shell -master=$MASTER | grep -q "$BUCKET"; then
                echo "Creating bucket $BUCKET for user loki..."
                echo "s3.bucket.create -name=$BUCKET -owner=loki" | weed shell -master=$MASTER
             else
                echo "Bucket $BUCKET already exists."
             fi
          done

          # Alertmanager Buckets
          for BUCKET in alertmanager; do
             echo "Checking bucket $BUCKET..."
             if ! echo "s3.bucket.list" | weed shell -master=$MASTER | grep -q "$BUCKET"; then
                echo "Creating bucket $BUCKET for user alertmanager..."
                echo "s3.bucket.create -name=$BUCKET -owner=alertmanager" | weed shell -master=$MASTER
             else
                echo "Bucket $BUCKET already exists."
             fi
          done

          # 3. Assign Buckets to Users (Strict Ownership)
          echo "Assigning Buckets to Users..."
          weed shell -master=$MASTER <<EOF
          s3.configure -user=mimir -buckets=mimir-tsdb,mimir-ruler,mimir-alertmanager -apply
          s3.configure -user=loki -buckets=loki-chunks,loki-ruler,loki-admin -apply
          s3.configure -user=alertmanager -buckets=alertmanager -apply
          EOF
        command:
        - /bin/sh
        - -c
        image: chrislusf/seaweedfs:4.09
        name: create-buckets
      restartPolicy: OnFailure
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: selfsigned-issuer
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  labels:
    app.kubernetes.io/component: admin
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: ingress-seaweedfs-admin
  namespace: storage
spec:
  rules:
  - host: admin.seaweedfs.ruth.example.com
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-admin
            port:
              number: 23646
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - admin.seaweedfs.ruth.example.com
    secretName: seaweedfs-cert
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: selfsigned-issuer
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  labels:
    app.kubernetes.io/component: filer
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: ingress-seaweedfs-filer
  namespace: storage
spec:
  rules:
  - host: filerseaweed.ruth.example.com
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-filer
            port:
              number: 8888
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - filerseaweed.ruth.example.com
    secretName: seaweedfs-cert
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: selfsigned-issuer
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  labels:
    app.kubernetes.io/component: master
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: ingress-seaweedfs-master
  namespace: storage
spec:
  rules:
  - host: seaweedfs.ruth.example.com
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-master
            port:
              number: 9333
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - seaweedfs.ruth.example.com
    secretName: seaweedfs-cert
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: selfsigned-issuer
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  labels:
    app.kubernetes.io/component: s3
    app.kubernetes.io/instance: seaweedfs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: seaweedfs
    helm.sh/chart: seaweedfs-4.0.409
  name: ingress-seaweedfs-s3
  namespace: storage
spec:
  rules:
  - host: s3.ruth.example.com
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-s3
            port:
              number: 8333
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - s3.ruth.example.com
    secretName: seaweedfs-cert
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: selfsigned-issuer
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  name: seaweedfs-volume
  namespace: storage
spec:
  rules:
  - host: volume.seaweedfs.ruth.example.com
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-volume
            port:
              number: 8080
        path: /
        pathType: Prefix
  - host: '*.seaweedfs-volume.seaweedfs.ruth.example.com'
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-volume
            port:
              number: 8080
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - volume.seaweedfs.ruth.example.com
    secretName: seaweedfs-cert
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: selfsigned-issuer
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  name: seaweedfs-webdav
  namespace: storage
spec:
  rules:
  - host: webdav.seaweedfs.ruth.example.com
    http:
      paths:
      - backend:
          service:
            name: seaweedfs-webdav
            port:
              number: 7333
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - webdav.seaweedfs.ruth.example.com
    secretName: seaweedfs-cert
