# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible.json#/$defs/tasks
# tasks/cluster.yml
---
- name: Ensure Kind config directory exists
  ansible.builtin.file:
    path: /etc/kubernetes/kind
    state: directory
    mode: "0755"
  tags: [kind, cluster]

- name: Generate Kind cluster config
  ansible.builtin.template:
    src: kind-config.yaml.j2
    dest: /etc/kubernetes/kind/config.yml
    mode: "0644"
  tags: [kind, cluster]

- name: Check if Kind cluster already exists
  ansible.builtin.command: kind get clusters
  register: existing_clusters
  changed_when: false
  tags: [kind, cluster]

- name: Create Kind cluster
  ansible.builtin.command: >
    kind create cluster
    --name {{ kind_cluster_name }}
    --config /etc/kubernetes/kind/config.yml
  when: kind_cluster_name not in existing_clusters.stdout
  changed_when: true
  tags: [kind, cluster]
