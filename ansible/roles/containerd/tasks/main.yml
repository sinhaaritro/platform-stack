
---

# Note: These first two steps are duplicated from the 'docker' role to keep this role self-contained.

- name: Add Docker GPG apt Key
  ansible.builtin.get_url:
  url: https://download.docker.com/linux/ubuntu/gpg
  dest: /etc/apt/trusted.gpg.d/docker.asc
  mode: '0644'
  force: true

- name: Add Docker Repository
  ansible.builtin.apt_repository:
  repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
  state: present

- name: Install containerd
  ansible.builtin.apt:
    name: containerd.io
  state: present
  update_cache: yes

- name: Ensure containerd config directory exists
  ansible.builtin.file:
  path: /etc/containerd
  state: directory
  mode: '0755'

- name: Generate default containerd configuration
  ansible.builtin.command: containerd config default > /etc/containerd/config.toml
  args:
  creates: /etc/containerd/config.toml

- name: Enable SystemdCgroup in containerd config
  ansible.builtin.lineinfile:
  path: /etc/containerd/config.toml
  regexp: 'SystemdCgroup = false'
  line: ' SystemdCgroup = true'

- name: Restart and enable containerd service
  ansible.builtin.systemd:
    name: containerd
  state: restarted
  enabled: yes
