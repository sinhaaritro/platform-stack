# tasks/install.yml
---
- name: Create ArgoCD Namespace
  ansible.builtin.shell: |
    set -o pipefail
    kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
  args:
    executable: /bin/bash
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname == kubeadm_bootstrap_node
  register: argocd_ns
  changed_when: "'created' in argocd_ns.stdout or 'configured' in argocd_ns.stdout"

- name: Add ArgoCD Helm Repository
  ansible.builtin.command: helm repo add argo https://argoproj.github.io/argo-helm
  changed_when: false
  when: inventory_hostname == kubeadm_bootstrap_node

- name: Update Helm Repos
  ansible.builtin.command: helm repo update
  changed_when: false
  when: inventory_hostname == kubeadm_bootstrap_node

- name: Render ArgoCD Values
  ansible.builtin.template:
    src: values.yaml.j2
    dest: /tmp/argocd-values.yaml
    mode: "0644"
  when: inventory_hostname == kubeadm_bootstrap_node

- name: Deploy ArgoCD via Helm
  ansible.builtin.command: >
    helm upgrade --install argocd argo/argo-cd
    --version {{ argocd_chart_version }}
    --namespace {{ argocd_namespace }}
    -f /tmp/argocd-values.yaml
    --wait
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: true
  when: inventory_hostname == kubeadm_bootstrap_node
