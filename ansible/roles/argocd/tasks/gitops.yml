# tasks/gitops.yml
---
- name: Render Root Application Manifest
  ansible.builtin.template:
    src: root-app.yaml.j2
    dest: /tmp/root-app.yaml
    mode: "0644"
  when: inventory_hostname == kubeadm_bootstrap_node

- name: Apply Root Application (Bootstrap GitOps)
  ansible.builtin.command: kubectl apply -f /tmp/root-app.yaml
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: gitops_apply
  changed_when: "'created' in gitops_apply.stdout or 'configured' in gitops_apply.stdout"
  when: inventory_hostname == kubeadm_bootstrap_node
