# tasks/firewall.yml
---
- name: Set UFW default policies
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: "incoming", policy: "deny" }
    - { direction: "outgoing", policy: "allow" }
  tags: [security, ufw]

- name: Allow SSH from anywhere (Permissive Mode)
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
  when: not security_ssh_restricted_mode
  tags: [security, ufw]

- name: Allow SSH from restricted networks (Hardened Mode)
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    src: "{{ item }}"
  loop: "{{ security_ssh_allowed_networks }}"
  when: security_ssh_restricted_mode
  tags: [security, ufw]

- name: Allow ICMP (Ping) from local network
  community.general.ufw:
    rule: allow
    proto: any
    src: "192.168.0.0/24"
  tags: [security, ufw]

- name: Enable UFW
  community.general.ufw:
    state: enabled
  tags: [security, ufw]
