# tasks/join.yml
---
# ------------------------------------------------------------------------------
# 1. DYNAMIC BRAIN FINDER
# ------------------------------------------------------------------------------
- name: Identify my Control Plane
  loop: "{{ group_names }}"
  when:
    - (groups[item] | intersect(groups['k_control']) | length) > 0
    - item != 'k_control'
  ansible.builtin.set_fact:
    my_control_plane: "{{ groups[item] | intersect(groups['k_control']) | first }}"
  run_once: false

- name: Fail if no Control Plane found
  when: my_control_plane is not defined
  ansible.builtin.fail:
    msg: >-
      Could not determine the Control Plane for {{ inventory_hostname }}.
      Ensure this host shares a group (like k_management or k_fleet) with a Control Plane host.

# ------------------------------------------------------------------------------
# 2. CHECK STATUS
# ------------------------------------------------------------------------------
- name: Check if node is already joined (kubelet.conf)
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

# ------------------------------------------------------------------------------
# 3. AGGRESSIVE CLEANUP (Run ONLY if not joined)
# ------------------------------------------------------------------------------
- name: Aggressive Cleanup (Prepare for Join)
  when: not kubelet_conf.stat.exists
  block:
    # 3a. Clean Local State
    - name: Run kubeadm reset (Force)
      ansible.builtin.command: kubeadm reset -f
      changed_when: true

    - name: Remove CNI and Kubernetes Config directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes/
        - /var/lib/etcd
        - /root/.kube
        - "/home/{{ ansible_user }}/.kube"
        - /etc/cni/net.d

    # 3b. Clean Remote State (Master)
    # We do this blindly to ensure the name is free.
    - name: Delete old node record from Control Plane
      ansible.builtin.command: "kubectl delete node {{ inventory_hostname }} --ignore-not-found=true"
      delegate_to: "{{ my_control_plane }}"
      become: true
      become_user: "{{ ansible_user }}"
      changed_when: true

# ------------------------------------------------------------------------------
# 4. JOIN
# ------------------------------------------------------------------------------
- name: Generate Join Command
  when: not kubelet_conf.stat.exists
  delegate_to: "{{ my_control_plane }}"
  ansible.builtin.command: kubeadm token create --print-join-command
  register: join_command_output
  changed_when: false

- name: Join Kubernetes Cluster
  when: not kubelet_conf.stat.exists
  ansible.builtin.command: "{{ join_command_output.stdout }}"
  become: true
  changed_when: true
  tags: [kubeadm, join]
