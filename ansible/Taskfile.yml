# ansible/Taskfile.yml
# -----------------------------------------------------------------------------
# Taskfile for Managing Ansible Configuration
#
# This file provides a standardized command interface for running Ansible
# playbooks and ad-hoc commands against the infrastructure.
#
# PREREQUISITES:
#   - Ansible and Task are installed.
#   - SSH access to the target hosts is configured (keys loaded or agent active).
#
# USAGE:
#   - List all available tasks: task -l
#   - Ping all hosts: task ansible:ping
#   - Run the main site playbook: task ansible:apply
# -----------------------------------------------------------------------------

version: "3"

# GLOBAL VARIABLES
vars:
  # INVENTORY_FILE: Path to the inventory file.
  INVENTORY_FILE: "inventory.yml"
  # PLAYBOOK_FILE: Path to the main site playbook.
  PLAYBOOK_FILE: "site.yml"

# Environment variables applied to ALL tasks
env:
  # Force Ansible to use the local config file
  ANSIBLE_CONFIG: "{{.USER_WORKING_DIR}}/ansible/ansible.cfg"
  # Disable host key checking strictly (Solves the "Yes/No" prompt)
  ANSIBLE_HOST_KEY_CHECKING: "False"
  # Ensure SSH ignores known_hosts (Solves the "Offending key" error)
  ANSIBLE_SSH_ARGS: "-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

tasks:
  default:
    desc: "Lists all available tasks for Ansible."
    cmds:
      - task -l

  # ---------------------------------------------------------------------------
  # CORE WORKFLOW TASKS
  # ---------------------------------------------------------------------------

  ping:
    desc: "Pings all hosts in the inventory to verify connectivity."
    dir: "{{.USER_WORKING_DIR}}/ansible"
    cmds:
      - ansible all -m ping -i {{.INVENTORY_FILE}}

  apply:
    desc: "Runs the main site playbook to apply configurations."
    dir: "{{.USER_WORKING_DIR}}/ansible"
    cmds:
      - ansible-playbook -i {{.INVENTORY_FILE}} {{.PLAYBOOK_FILE}} {{.CLI_ARGS}}

  check:
    desc: "Runs the main site playbook in 'check' (dry-run) mode."
    dir: "{{.USER_WORKING_DIR}}/ansible"
    cmds:
      - ansible-playbook -i {{.INVENTORY_FILE}} {{.PLAYBOOK_FILE}} --check --diff {{.CLI_ARGS}}

  lint:
    desc: "Runs ansible-lint to check for best practices and errors."
    dir: "{{.USER_WORKING_DIR}}/ansible"
    cmds:
      - ansible-lint

  # ---------------------------------------------------------------------------
  # DYNAMIC COMMANDS
  # ---------------------------------------------------------------------------

  shell:
    desc: "Run an ad-hoc shell command on a group of hosts."
    summary: |
      Usage: task ansible:shell group=<target> cmd="<command>" [become=true]
      Example: task ansible:shell group=k_control cmd="kubectl get nodes"
    dir: "{{.USER_WORKING_DIR}}/ansible"
    vars:
      # Default to 'all' if group is not specified
      GROUP: '{{.group | default "all"}}'
      # Default to empty (no sudo), set become=true to enable
      BECOME_FLAG: '{{if eq .become "true"}}-b{{end}}'
    cmds:
      - ansible {{.GROUP}} -i {{.INVENTORY_FILE}} -m shell -a "{{.cmd}}" {{.BECOME_FLAG}}

  # ---------------------------------------------------------------------------
  # UTILITY TASKS
  # ---------------------------------------------------------------------------

  inventory:
    desc: "Lists the full inventory structure."
    dir: "{{.USER_WORKING_DIR}}/ansible"
    cmds:
      - ansible-inventory -i {{.INVENTORY_FILE}} --graph

  galaxy:
    desc: "Installs required Ansible collections and roles from galaxy."
    dir: "{{.USER_WORKING_DIR}}/ansible"
    cmds:
      - ansible-galaxy install -r requirements.yml

  setup-ssh:
    desc: "Configures local SSH client to ignore keys for Lab IPs (Optional Manual Fix)"
    cmds:
      - echo "Configuring ~/.ssh/config for 192.168.0.*..."
      - |
        echo "
        Host 192.168.0.*
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            User dev
            LogLevel ERROR
        " >> ~/.ssh/config
    status:
      - grep -q "Host 192.168.0.*" ~/.ssh/config
